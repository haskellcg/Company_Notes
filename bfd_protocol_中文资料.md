# Bidirectional Forwarding Detection (BFD)

## 产生背景
  为了保护关键应用，网络中会涉及有一定的冗余备份链路，网络发生故障时就要求网络设备能够快速检测出故障，并将流量切换到备份链路以加快网络收敛速度。目前有些链路(例如POS)通过硬件监测机制来实现快速故障检测。但是某些链路(例如以太网)不具备这样的检测机制，此时，应用就要依赖上层协议自身的机制来进行故障检测，上层协议的检测时间都在1秒以上，这样的故障检测事件对某些应用来说是不可容忍的。
  
## 技术优点
  BFD提供了一个通用的标准化的介质无关和协议无关的快速故障监测机制:
  * 对网络设备间任意类型的双向转发路径进行故障检测，包括直连物理链路、虚电路、隧道、MPLS、LSP、多跳路由协议路径以及单向链路等
  * 可以为不同的上层应用服务，提供一致的快速故障检测机制
  * 提供小于1秒的检测时间，从而加快网络收敛速度，减少应用中断时间，提高网络的可靠性
  
## BFD技术实现
### BFD实现简介
  BFD在两台网络设备上建立会话，用来检测网络设备间的双向转发路径，为上层应用服务。BFD本身并没有邻居发现机制，而是靠被服务的上层应用通知其邻居信息以建立会话。会话建立后会周期性地快速发送BFD报文，如果在检测时间内没有收到BFD报文则认为该双向转发路径发生了故障，同志被服务的上层应用进行相应的处理。
  
#### BFD会话建立  
  * OSPF通过自己的Hello机制发现邻居并建立连接
  * OSPF在建立了新的邻居关系后，将邻居信息(包括目的地址和源地址等)通告给BFD
  * BFD根据收到的邻居信息建立会话
  
#### BFD故障发现处理流程
  * 被检测链路出现故障
  * BFD检测到链路故障，拆除BFD邻居会话
  * BFD通知本地OSPF进行BFD邻居不可达
  * 本地OSPF进行中断OSPF邻居关系
  
  BFD有两种操作模式：异步模式和查询模式
  
  异步模式下，会话两端周期性地发送BFD控制报文，根据是否能收到对端的BFD控制报文来检测会话状态
  
  回声功能启动后，会话的一端周期性地发送BFD Echo报文，对端不对此报文进行处理，而只是讲此报文转发回发送端。根据发送端是否能收到BFD Echo报文来检测会话状态
  
  BFD会话的两端可能是在直连网段(即IP报文的一跳)，也可能在不同的网段。回声功能只能检测直连网段故障，即BFD Echo报文是单跳发送；而BFD控制报文可以检测直连网段和非直连网段的故障，即BFD控制报文可以是单跳或者多跳发送。
  
### BFD报文
#### BFD控制报文
  强制部分格式：

  Vers|Diag|Sta|P|F|C|A|D|R|Detect Mult|Length|My Discriminator|Your Discriminator|Desired Min TX Interval|Desired Min RX Interval|Required Min Echo RX Interval
  ----|----|---|-|-|-|-|-|-|-----------|------|----------------|------------------|-----------------------|------|-------
  3|5|2|1|1|1|1|1|1|8|8|32|32|32|32|32
  
  可选认证部分格式:
  
  Auth Type|Auth Len|Authentication Data
  ---------|--------|-------------------
  8|8|16
  
  字段含义:
  
  字段|含义
  ---|----
  Vers|BFD协议版本号，目前版本号为1
  Diag|诊断码，表明发送方最近一次会话Down的原因
  Sta|发送方BFD会话当前状态，取值为：0代表AdminDown，1代表Down，2代表Init，3代表Up
  P|会话参数变化时置位
  F|如果收到的BFD控制报文P字段置位，则将下一个发送的BFD控制报文的F字段位作为应答
  C|该字段置位表明BFD的实现是独立与控制平面的
  A|该字段置位表明报文包含认证部分，会话需要进行认证
  D|该字段置位表明发送方希望以查询模式运行，不置位表明不希望以查询模式或者不支持查询模式
  R|保留位，发送时设为0，接收时忽略该字段
  Detect Mult|检测时间倍数
  Length|BFD控制报文长度，单位是字节
  My Discriminator|发送方产生的一个唯一非0值，用来标识不同的BFD会话
  Your Discriminator|如果已经收到会话邻居发送的BFD控制报文则为收到报文的My Discriminator，否则为0
  Desired Min TX Interval|发送方支持的最小BFD控制报文发送时间间隔，单位是毫秒
  Required Min RX Interval|发送方支持的最小BFD控制报文接收时间间隔，单位是毫秒
  Required Min Echo RX Interval|发送方支持的最小BFD Echo报文接收时间间隔，单位是毫秒，为0表示不支持BFD Echo报文
  Auth Type|认证类型
  Auth Len|可选认证部分长度，包括Auth Type和Auth Len字节段，单位是字节
  
  **_BFD控制报文采用UDP封装，目的端口号为3784，原端口号在49152到65535_**
  
#### BFD Echo报文
  BFD Echo报文提供了一种不依赖于BFD控制报文的故障检测方法。本端发送端接收，远端不对报文进行处理，而只是将此报文在反方向通道返回。因此BFD协议并没有对BFD Echo报文的格式进行定义，唯一的要求是发送方能够通过报文内容区分会话。
  
  BFD Echo报文采用UDP封装，目的端口3785，目的IP地址为发送方接口的地址，源IP地址由配置产生(配置的源IP地址要避免产生ICMP重定向)
  
### BFD会话连接建立  
  **_BFD会话建立有主动与被动两种模式_**。如果一台设备为主动模式，那么在会话建立前不管有没有收到对端发来的BFD控制报文，都会主动发送BFD控制报文。如果一台设备为被动模式，那么在会话建立前就不会主动发送控制报文，直到收到对端发来的BFD控制报文才发送。
  
  **_要建立BFD会话的两端中至少要有一端为主动模式才可能成功建立会话_**。
  
  BFD使用三路握手的机制来建立会话，发送方在发送BFD控制报文时会在Sta字段填入本地当前的会话状态，接收方根据收到的BFD控制报文的Sta字段以及本地当前会话Sta进行状态机的迁移，建立会话：
  * Router A和Router B的BFD收到上层应用的通知后，发送状态为Down的BFD控制报文。B的状态如同A
  * B收到对端状态为Down的BFD控制报文后，本地会话状态由Down转移到Init，随后发送的BFD控制报文中将Sta字段填为2表明会话状态为Init， A的状态如同B
  * A收到对端状态为Init的BFD控制报文后，本地会话状态由Init转移到Up，随后发送的BFD控制报文将Sta字段填为3表明会话状态为Up，B的状态如同A
  * BFD双方状态均为Up，会话成功建立并开始检测链路状态
  
### 定时器协商
  BFD会话建立前BFD控制报文以1秒的时间间隔周期发送以减少报文流量。会话建立后则以协商的时间间隔发送BFD控制报文以实现快速检测。在BFD会话建立的同时，BFD控制报文发送的时间间隔以及检测时间也会通过报文协商确定。在BFD会话有效期间，有些的定时器可以随时修改为不会影响会话状态。BFD会用不同方向的定时器协商是分别独立进行的，双向定时器时间可以不同。
  
  BFD控制报文发送时间间隔为本端Desired Min TX Interval和对端Required Min RX Interval之中的最大值。
  
  检测时间为对端BFD控制报文中的Detect Mult乘以经过协商的对端BFD控制报文发送时间间隔。
  
  如果加大本端的Desired Min TX Intreval或者减小本端的Required Min RX Interval，那么本端实际发送的BFD控制报文的时间间隔必须等到对端F字段置位的报文后才能改变，这是为了确保在本端加大BFD控制报文发送时间间隔前对端已经加大了检测时间，否则可能导致对端检测定时器错误超时。
  
  如果减小Desired Min TX Interval，本端BFD控制报文发送时间会立即减小；加大Required Min Rx Interval，本端检测时间将会立即加大。
 
  Router A与Router B建立BFD会话，双方的Desired Min TX Interval和Required Min RX Interval都为100ms，Detect Mult都为3.根据定时器协商规则，A的发送时间间隔为A的TX与B的RX的最大值，也就是100ms，B的发送时间间隔也是100ms，双方的检测超时时间都为300ms。
  
  如果此时将A的TX和RX加到150ms：
  * A比较本端的RX和TX的TX，从而将本端的检测时间改为450ms。同时向对端发送P字段置位的BFD控制报文(TX和RX均为150ms)
  * B收到报文后，给A回复F字段置位的BFD控制报文(TX和RX均为100ms)，同时将收到报文中的RX与本端的TX进行比较，由于TX较大，故B的发送时间间隔改为150ms，经过比较本端的RX和对端的TX，从而将检测时间也增大到450ms
  * 定时器协商完成，双方的发送间隔和检测时间分别为150ms和450ms
  
### 故障检测
  BFD会话建立及定时器协商完毕后，两端会以协商后的间隔发送BFD控制报文。每当收到BFD控制报文时，就会重置检测时间定时器，保持会话Up状态。如果在检测时间内没有收到BFD控制报文，BFD状态转移到Down状态，并通知该会话所服务的上层应用发生故障，由上层应用采取相应的措施。本端BFD会话Down后，发给对端的BFD控制报文中的Sta字段就填1，通知对端会话Down，对端的BFD会话也转移到Down状态。
  
## 典型组网应用
### 路由协议与BFD联动典型组网应用
### 快速重路由与BFD联动典型组网应用
### VRRP与BFD联动典型组网应用
  
  
## 参考
  * [BFD技术白皮书](http://blog.163.com/hlz_2599/blog/static/1423784742014101685812527/)
