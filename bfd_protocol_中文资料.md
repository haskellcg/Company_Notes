# Bidirectional Forwarding Detection (BFD)

## 产生背景
  为了保护关键应用，网络中会涉及有一定的冗余备份链路，网络发生故障时就要求网络设备能够快速检测出故障，并将流量切换到备份链路以加快网络收敛速度。目前有些链路(例如POS)通过硬件监测机制来实现快速故障检测。但是某些链路(例如以太网)不具备这样的检测机制，此时，应用就要依赖上层协议自身的机制来进行故障检测，上层协议的检测时间都在1秒以上，这样的故障检测事件对某些应用来说是不可容忍的。
  
## 技术优点
  BFD提供了一个通用的标准化的介质无关和协议无关的快速故障监测机制:
  * 对网络设备间任意类型的双向转发路径进行故障检测，包括直连物理链路、虚电路、隧道、MPLS、LSP、多条路由协议路劲以及单向链路等
  * 可以为不同的上层应用服务，提供一直的快速故障检测时间
  * 提供小于1秒的检测时间，从而加快网络收敛速度，减少应用中断时间，提高网络的可靠性
  
## BFD技术实现
### BFD实现简介
  BFD在两台网络设备上建立会话，用来检测网络设备间的双向转发路径，为上层应用服务。BFD本身并没有邻居发现机制，而是靠被服务的上层应用通知其邻居信息以建立会话。会话建立后会周期性地快速发送BFD报文，如果在检测时间内没有收到BFD报文则认为该双向转发路径发生了故障，同志被服务的上层应用进行相应的处理。
  
#### BFD会话建立  
  * OSPF通过自己的Hello机制发现邻居并建立连接
  * OSPF在建立了新的邻居关系后，将邻居信息(包括目的地址和源地址等)通告给BFD
  * BFD根据收到的邻居信息建立会话
  
#### BFD故障发现处理流程
  * 被检测链路出现故障
  * BFD检测到链路故障，拆除BFD邻居会话
  * BFD通知本地OSPF进行BFD邻居不可达
  * 本地OSPF进行中断OSPF邻居关系
  
  BFD有两种操作模式：异步模式和查询模式
  
  异步模式下，会话两端周期性地发送BFD控制报文，根据是否能收到对端的BFD控制报文来检测会话状态
  
  回声功能启动后，会话的一端周期性地发送BFD Echo报文，对端不对此报文进行处理，而只是讲此报文转发回发送端。根据发送端是否能收到BFD Echo报文来检测会话状态
  
  BFD会话的两端可能是在直连网段(即IP报文的一跳)，也可能在不同的网段。回声功能只能检测直连网段故障，即BFD Echo报文是单跳发送；而BFD控制报文可以检测直连网段和非直连网段的故障，即BFD控制报文可以是单跳或者多跳发送。
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  ## 参考
  * [BFD技术白皮书](http://blog.163.com/hlz_2599/blog/static/1423784742014101685812527/)
  * []()
