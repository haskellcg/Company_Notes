## PIM
  * 由IDMR工作组设计
  * 不依赖于特定的单播路由协议，它可以利用各种单播路由协议建立的单播路由表完成
  * 在Internet范围内支持SPT和共享树，并使两者之间灵活切换，因而集中了他们的优点
  * PIM-DM(Dense-Mode): PIM密集模式，RFC3973
  * PIM-SM(Sparse-Mode): PIM稀疏模式，RFC2362  
  
## PIM-SM (中文文档)
  协议无关组播，就是在做RPF检查以及发送特定的协议单播报文的时候利用单播路由表，而和具体采用何种单播路由协议并没有关系，该协议也不保持自己的路由表，为IP组播提供路由的单播路由协议可以是静态路由、RIP、OSPF、IS-IS、BGP等。

#### 概述
  * PIM-SM是稀疏模式的组播路由协议，主要用于成员分布相对分散、范围较广、大规模的网络
  * 协议假设：当组播源开始发送组播数据时，域内的所有节点都不需要接收数据
  * 该模型转发的核心任务就是构造并维护一颗单向共享树，共享树选择PIM中某一路由器作为公用根节点，成为汇聚点RP(Rendezvous Point)。组播数据通过RP沿共享树向接受者转发
  * 接受者发现DR(Designated Router)，由DR创建(\*, G)项并以Join消息发送到RP
  * 组播源同样发现DR(第一跳路由器)，并通过DR在RP上注册源信息
  * 同时包含两种树:共享树、原路径树
  * RPF检查根据树的类型进行:
    * 使用共享树进行数据接收转发时，使用RP地址作为检测地址
    * 使用原路径树进行数据接收转发时，使用组播源地址作为检测地址
  * BSR (BootStrap Router)在PIM-SM网络启动后，负责收集网络内的RP信息，为每个组播组选举RP，然后将RP集(即组-RP的映射数据库)发布到整个网络，PIM-SM域内只有一台BSR，可同时存在多台候选BSR

#### 关键点:
  * PIM-SM的基本原理
  * 共享树的加入和源的注册过程
  * RPT和SPT的切换

#### 字段解释
  版本|类型|保留|检验和
  ----|---|---|-----
  3|7|15|31
  
  * **_版本_**: 当前为2
  
  * **_类型_**：
    * 0: hello
    * 1: 注册 (only SM)
    * 2: 停止注册 (only SM)
    * 3: 加入/剪枝
    * 4: Bootstrap (only SM)
    * 5: Assert
    * 6: 嫁接 (only DM)  
    * 7: 嫁接回应 (only DM)
    * 8: 候选RP公告 (only SM)
  
  * **_保留_**
  
  * **_检验和_**
  
#### 协议机制
  * **邻居发现**: 组播路由需要使用Hello消息来发现邻居，并维护邻居关系
  
  * **DR选举**: 借助Hello消息可以为共享网络(如Ethernet)选举DR，DR将作为本网段中组播消息的唯一转发者，无论是和组播源连接的网络，还是和接收者连接的网络，只要网络为共享媒介都需要选举DR，接收者侧的DR向RP发送Join加入消息，组播源侧DR向RP发送Register注册消息
  
  * **BSR的选举**:
    * 如果域内只有一台C-BSR，该台路由器就是该域内的BSR
    * 如果域内存在多台C-BSR，则拥有最高优先级的路由器为BSR
    * 如果域内存在多台拥有相同优先级的C-BSR，则拥有最高IP地址的路由器为BSR
    
  * **RP发现**: 组播网络中，担当共享树根节点的节点就是RP，共享树里所有组播流都通过RP转发到接收者，RP可以负责几个或者所有组播组的转发，所以网络中可以有一个到多个RP负责不同的组播组:
    * 在DR和叶子路由器以及组播数据流将要经过的所有路由器上手工指定RP
    * 启动Bootstrap协议，利用自举机制动态选举RP
    
  * **利用BootStrap协议选举RP**:
    * 如果PIM-SM域内只有一个C-RP(Candidat-RP)，那么这个节点就是域内的RP
    * 如果域内存在多个C-RP并拥有不同的优先级，那么优先级最高额将会被选举为RP
    * 如果域内存在多个C-RP并都拥有相同的优先级时，则依靠Hash算法算出的树枝决定RP，数值最大的成为RP，Hash算法参数：组地址、掩码长度、C-RP地址
    * 如果域内存在多个C-RP并且拥有相同的优先级和Hash数值，则拥有最高IP地址的C-RP为该域的RP
    
  * **RP与BSR的关系**:
    * C-RP将声明发送给BSR，C-RP通过单播周期发送通告，BSR在RP集存储所有的C-RP通告
    * BSR周期性地向所有PIM路由器发送BSR消息，BSR消息包含整个RP-set和BSR地址，消息一跳一跳地自BSR向整个网络泛滥
    * 所有路由器使用收到的RP-set来确定RP，所有路由器使用相同的RP选择算法，选择的RP也是一样的
    
  * **RPT共享树加入**: IGMP, (\*, G)
  
  * **组播源注册**: (S, G)注册, (S, G)加入, 源树，共享树、数据流，**停止注册**， **组播流转发**
  
  * **SPT切换**: RPT向SPT切换，切换后组播的转发，切换后的剪枝，SPT的切换条件:
    * 当信息吞吐率超过预定值，PIM-SM就会从共享树切换到组播源路径树
    * Quidway系列设备中(VRP平台)，缺省情况下，连接接收者的路由器在探测到组播源之后，变立即加入最短路径树(源树)，即从RPT向SPT切换

#### 评价
  * 对于稀疏、密集模式应用都很有效
  * 数据流仅沿“加入”的分支向下发送
  * 可以根据流量条件等动态的切换到源树
  * 和具体的单播路由协议无关
  * 是域内组播路由的基础，和MGBP、MSDP共同结合使用可以完成跨域的组播
